<%- layout('layouts/boilerplate') %>
    <h1>Hi From Patient show page</h1>
    <div class="row my-4" data-patient-id="<%= patient_id %>" id="patient">
        <div class="col-4 offset-2">
            <div class="card d-flex flex-column">
                <% for(const m of medicalHistory){ %>
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div class="card-title">
                            <%=m.medical_history_diagnosis%>
                        </div>
                        <div class="card-text"><a class="btn btn-secondary search-treatment"
                                href="/treatment/search/<%= m.treatment_id %>" onclick="return false;">Open
                                Treatment</a></div>
                    </div>
                <% } %>                    
            </div>
        </div>
        <div class="col-4" id="search-result"></div>
    </div>
    <div class="row mt-5">
        <div class="col-6 offset-3">
            <form id="form">
                <div class="mb-3">
                    <label for="diagnosisReason" class="form-label">Diagnosis Reason: </label>
                    <input type="text" class="form-control" id="diagnosisReason" name="appointment_reason">
                </div>
                <div class="mb-3">
                    <select class="form-select" name="appointment_type">
                        <option selected>Choose a type</option>
                        <option value="OFFLINE">Offline Appointment</option>
                        <option value="ONLINE">Online Appointment</option>
                    </select>
                </div>
                <div class="mb-3">
                    <input type="datetime-local" class="form-control" id="date_time">
                    <button id="checkDatebutton" class="btn btn-info text-white mt-1">Check</button>
                    <div id="invalid" class="d-none alert alert-warning"></div>
                </div>
                <button type="submit" class="btn btn-primary">Submit</button>
            </form>
        </div>
    </div>
    <script>
        const searchTreatment = document.querySelectorAll('.search-treatment');
        const searchResult = document.getElementById('search-result');
        let activeTab = '';
        searchTreatment.forEach(e => {
            e.addEventListener('click', async (ele) => {
                if (!(activeTab === '')) {
                    activeTab.classList.remove('btn-success');
                }
                activeTab = ele.target;
                ele.target.classList.add('btn-success');
                const link = ele.target.attributes[1].value;
                const result = await fetch(link);
                const result1 = await result.text();
                searchResult.innerHTML = result1;
            })
        })
    </script>
    <script>
        const form = document.querySelector('#form');
        const dateTime = document.querySelector('#date_time');
        const checkButton = document.querySelector('#checkDatebutton'); 
        const patientIdHolder = document.querySelector('#patient');
        const invalid = document.querySelector('#invalid');

        const doctor_id = window.location.pathname.split('/')[4];
        const patient_id = patientIdHolder.getAttribute('data-patient-id');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
        })

        checkButton.addEventListener('click', async () => {
            const tmp = dateTime.value;
            const date = tmp.slice(0, 10);
            const time = tmp.slice(11, 16); 
            // check if this date is Available for this doctor and this patient 
            // result must be 0 => the doctos has 0 appointments so as the patient
            const result = await fetch(`/appointment/checkDate/search?patient_id=${patient_id}&doctor_id=${doctor_id}&date=${date}&time=${time}`);
            const data = await result.json();
            if (data[0].patient_id == patient_id) {
                invalid.classList.remove('d-none');
                invalid.classList.add('d-block');
                setTimeout(()=>{
                    invalid.innerText = 'You Have another appointment';
                }, 2000)
               
            }else if(data[0].doctor_id == doctor_id){
                invalid.classList.remove('d-none');
                invalid.classList.add('d-block');
                invalid.innerText = 'Doctor Has another appointment';
            } 
        });
    </script>