<%- layout('layouts/boilerplate') %>
    <div class="row mb-3">
        <div class="card col-4 offset-4">
            <ul class="list-group list-group-flush">
                <li class="list-group-item">Full Name: <%= doctor.person_name %></li>
                <li class="list-group-item">Speciality: <%= doctor.doctor_speciality %></li>
                <li class="list-group-item">Phone Number: </li>
            </ul>
        </div>
    </div>
    
    <div class="row my-4" data-patient-id="<%= patient_id %>" id="patient">
        <div class="col-3 offset-3">
            <div class="card d-flex flex-column">
                <% for(const m of medicalHistory){ %>
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div class="card-title">
                            <%=m.medical_history_diagnosis%>
                        </div>
                        <div class="card-text"><a class="btn btn-secondary search-treatment"
                                href="/treatment/search/<%= m.treatment_id %>" onclick="return false;">Open
                                Treatment</a></div>
                    </div>
                <% } %>
            </div>
        </div>
        <div class="col-3" id="search-result"></div>
    </div>
    <div class="row mt-auto">
        <div class="col-6 offset-3">
            <form id="form" class="text-center">
                <div class="mb-3 text-start">
                    <label for="diagnosisReason" class="form-label">Diagnosis Reason: </label>
                    <input type="text" class="form-control" id="diagnosisReason" name="appointment_reason">
                </div>
                <div class="mb-3">
                    <select class="form-select" name="appointment_type">
                        <option selected>Choose a type</option>
                        <option value="OFFLINE">Offline Appointment</option>
                        <option value="ONLINE">Online Appointment</option>
                    </select>
                </div>
                <div class="mb-3">
                    <input type="datetime-local" class="form-control" id="date_time">
                    <div id="invalid" class="d-none alert alert-warning"></div>
                    <div id="valid" class="d-none alert alert-info"></div>
                </div>
                <button type="submit" class="btn btn-primary" id="submitFormButton">Submit</button>
            </form>
        </div>
    </div>
    <script>
        const searchTreatment = document.querySelectorAll('.search-treatment');
        const searchResult = document.getElementById('search-result');
        let activeTab = '';
        searchTreatment.forEach(e => {
            e.addEventListener('click', async (ele) => {
                if (!(activeTab === '')) {
                    activeTab.classList.remove('btn-success');
                }
                activeTab = ele.target;
                ele.target.classList.add('btn-success');
                const link = ele.target.attributes[1].value;
                const result = await fetch(link);
                const result1 = await result.text();
                searchResult.innerHTML = result1;
            })
        })
    </script>
    <script>
        const form = document.querySelector('#form');
        const dateTime = document.querySelector('#date_time');
        const patientIdHolder = document.querySelector('#patient');
        const invalid = document.querySelector('#invalid');
        const valid = document.querySelector('#valid');
        const submitFormButton = document.querySelector('#submitFormButton');

        const doctor_id = window.location.pathname.split('/')[4];
        const patient_id = patientIdHolder.getAttribute('data-patient-id');
        let submitFlag = false;

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
        })
        dateTime.addEventListener('change', async () => {
            const tmp = dateTime.value;
            const tmp_date = new Date(tmp);
            const result = await fetch(`/appointment/checkDate/search?patient_id=${patient_id}&doctor_id=${doctor_id}&date=${tmp}`);
            const data = await result.json();
            // check if this date is Available for this doctor and this patient 
            // result must be 0 => the doctos has 0 appointments so as the patient
            if (data.status === 'success') {
                submitFlag = true;
                valid.classList.add('d-block');
                valid.classList.remove('d-none');
                valid.innerText = data.message;
                setTimeout(() => {
                    valid.innerText = '';
                    valid.classList.remove('d-block');
                    valid.classList.add('d-none');
                }, 2000);
            } else {
                submitFlag = false;
                invalid.classList.add('d-block');
                invalid.classList.remove('d-none');
                invalid.innerText = data.message;
                setTimeout(() => {
                    invalid.innerText = '';
                    invalid.classList.remove('d-block');
                    invalid.classList.add('d-none');
                }, 2000);
            }
            submitFormButton.addEventListener('click', () => {
                if (submitFlag) {
                    const insertData = {
                        doctor_id: doctor_id,
                        patient_id: patient_id,
                        appointment_date: tmp,
                        appointment_type: form[1].value,
                        appointment_reason: form[0].value,
                    }
                    const url = `/appointment/createAppointment`;
                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(insertData)
                    })
                }
            });
        });

    </script>