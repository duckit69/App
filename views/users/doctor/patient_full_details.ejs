<%- layout('layouts/doctorBoilerplate') %>
    <div class="container-fluid vh-100 d-flex flex-column justify-content-around">
        <div class="row mx-auto d-flex justify-content-center w-100">
            <h1 class="mb-5">
                <%= result.patient[0].person_name %> Full details
            </h1>
            <div class="col-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title text-black">
                            <%= result.patient[0].person_name %>'s SENSORS
                        </h5>
                        <%= console.log(result.patient[0].person_id)%>
                        <div class="container d-flex gap-2 sensors-container">
                            <% for(const [index, s] of sensors.entries()){ %>
                            <% const backgroundColor=(index % 2)==0 ? 'green-background' : 'purple-background' ; %>
                                    <div class="card <%= backgroundColor%> text-white">
                                        <div class="card-body">
                                            <h5 class="card-title fs-4">
                                                <%= s.sensor_name %>
                                            </h5>
                                            <p class="lead fw-bold fs-6">MAX: 136mmHg</p>
                                            <p class="lead fw-bold fs-6">MIN: 136mmHg</p>
                                            <p class="lead fw-bold fs-6">Curr: 136mmHg</p>
                                            <form action="/sensor/<%= s.sensor_id %>?_method=DELETE" method="post"
                                                id="sensorDelete" class="text-center">
                                                <button class="btn btn-md btn-danger">Delete</button>
                                            </form>
                                        </div>
                                    </div>
                            <% } %>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="container-fluid">
                            <form action="/medicalHistory/" method="post" class="d-none" id="medicalHistoryForm"
                                style="min-height: 250px;">
                                <div class="mb-3">
                                    <select class="form-select" name="treatment" id="treatmentType">
                                        <option selected disabled>Select Treatment</option>
                                        <option value="prescription">Prescription</option>
                                        <option value="scanner">Scanner</option>
                                    </select>
                                </div>
                                <input type="hidden" name="from_doctor" value="<%= result.patient[0].person_id %>">
                                <button class="btn green-background text-white fw-bold d-none mt-3"
                                    id="submitMedicalHistoryForm">Add Medical History</button>
                            </form>
                        </div>
                        <div class="container-fluid d-flex gap-3" id="medicalHistoryBox">
                            <button
                                class="lead fw-bold fs-6 my-auto border-0 bg-transparent treatment-type">Prescription</button>
                            <div class="vr"></div>
                            <button
                                class="lead fw-bold fs-6 my-auto border-0 bg-transparent treatment-type">Scanner</button>
                            <div class="vr"></div>
                            <button
                                class="lead fw-bold fs-6 my-auto border-0 bg-transparent treatment-type">Analyse</button>
                            <div class="vr"></div>
                            <button
                                class="lead fw-bold fs-6 my-auto border-0 bg-transparent treatment-type">Radio</button>
                        </div>
                        <div class="container-fluid mt-4" id="treatments-box">
                            <div class="row" id="medicalHistoryRow">
                                <div class="col-5">
                                    <div class="vstack gap-3">
                                        <div class="card" style="min-height: 250px;">
                                            <div class="card-body medical-history-height d-flex flex-column gap-2"
                                                id="treatments">

                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6 w-auto" id="search-result"></div>
                            </div>
                        </div>
                        <div class="div d-flex justify-content-end align-content-end">
                            <a class="" id="addMedicalHistory"><img src="/pics/add_medical_history.svg"
                                    style="height: 40px;"></a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-3">
                <div class="card">
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">Cardiovascular Risk</li>
                            <li class="list-group-item d-flex flex-column"> <span
                                    class="btn green-background text-white fw-bold" id="riskFactorButton"> Risk Factors:
                                    <%= Evaluation.counter %></span>
                                <div id="riskFactors" class="vstack gap-3"
                                    style="max-height: 80px; overflow-x: hidden; overflow-y: scroll;">
                                    <% for(const factor in Evaluation.factors) { %>
                                        <div class="p-2">
                                            <%= factor %>: <%= Evaluation.factors[factor] %>
                                        </div>
                                        <% } %>
                                </div>
                            </li>
                            <li class="list-group-item">Risk Class: <%= Evaluation.riskClass %>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const searchTreatment = document.querySelectorAll('.search-treatment');
        const searchResult = document.getElementById('search-result');
        const treatment_box = document.querySelector('#treatments-box');

        let activeTab = '';
        searchTreatment.forEach(e => {
            e.addEventListener('click', async (ele) => {
                if (!(activeTab === '')) {
                    activeTab.classList.remove('btn-success');
                }
                activeTab = ele.target;
                ele.target.classList.add('btn-success');
                const link = ele.target.attributes[1].value;
                const result = await fetch(link);
                const result1 = await result.text();
                searchResult.innerHTML = result1;
            })
        })
    </script>


    <script>
        const addMedicalHistoryButton = document.querySelector('#addMedicalHistory');
        const medicalHistoryForm = document.querySelector('#medicalHistoryForm');
        const medicalHistoryRow = document.querySelector('#medicalHistoryRow');
        const medicalHistoryBox = document.querySelector('#medicalHistoryBox');

        addMedicalHistoryButton.addEventListener('click', () => {
            addMedicalHistoryButton.classList.add('d-none');
            medicalHistoryRow.classList.add('d-none');
            medicalHistoryBox.classList.add('d-none');
            treatment_box.classList.add('d-none');
            medicalHistoryForm.classList.remove('d-none');
        })
    </script>
    <script>
        const treatment_type = document.querySelectorAll('.treatment-type');
        const treatments = document.querySelector('#treatments');
        let activeType = null;
        let activeEle = null;
        treatment_type.forEach( async (e) => {
            e.addEventListener('click', async () => {
                if (activeType) {
                    activeType.classList.remove('btn-primary')
                    activeType.classList.add('btn-light');
                }
                searchResult.innerHTML = '';
                activeType = e;
                activeType.classList.remove('btn-light')
                activeType.classList.add('btn-primary');
                treatment_box.classList.remove('d-none');
                const result = await fetch(`/treatment/${e.innerHTML}?patient_id=${"<%= result.patient[0].person_id %>"}`);
                const response = await result.json();
                console.dir(response);
                treatments.innerHTML = '';
                console.dir(response);
                for (const r of response) {
                    if (r.image_name) {
                        treatments.innerHTML += `<div class="btn btn-light scanner">${r.medical_history_diagnosis}</div>`;
                    } else {
                        treatments.innerHTML += `<div class="btn btn-light tret" data-treatment-id=${r.treatment_id}>${r.medical_history_diagnosis}</div>`;
                    }
                }
                // for (const r of response) {
                //     if (r.medicine_name) {
                //         treatments.innerHTML += `<div class="btn btn-light pres">${r.medical_history_diagnosis}</div>`;
                //     }else if(r.image_type) {
                //         treatments.innerHTML += `<div class="btn btn-light scanner">${r.medical_history_diagnosis}</div>`;
                //     }
                //     else if(r.image_type == 'radio') {
                //         treatments.innerHTML += `<div class="btn btn-light radio">${r.medical_history_diagnosis}</div>`;
                //     }
                //     else if(r.image_type == 'analyse') {
                //         treatments.innerHTML += `<div class="btn btn-light analyse">${r.medical_history_diagnosis}</div>`;
                //     }
                // }
                const pres = document.querySelectorAll('.tret');
                    pres.forEach(element => {
                        element.addEventListener('click', async () => {
                            const tret_ID = element.getAttribute('data-treatment-id');
                            const link = `/treatment/search/${tret_ID}`;
                            if (activeEle) {
                                activeEle.classList.remove('btn-success');
                                activeEle.classList.add('btn-light');
                            }
                            activeEle = element;
                            searchResult.innerHTML = '';
                            activeEle.classList.remove('btn-light');
                            activeEle.classList.add('btn-success');
                            const obj = response.find(e => e.medical_history_diagnosis == activeEle.innerHTML)
                            const medicines = await fetch(link);
                            const r = await medicines.json();
                            console.dir(r.div);
                            searchResult.innerHTML += `
                                <div class="card-body rounded border border-2"> 
                                    <p class="lead">${obj.medical_history_notes}</p>
                                    ${r.div}
                                    <button class="btn btn-primary dwnld">Download</button> 
                                    <button class="btn btn-danger text-white cls">Close</button>
                                </div>`;
                            const cls = searchResult.childNodes[1].childNodes[5];
                            const dwnld = searchResult.childNodes[1].childNodes[3];

                            cls.addEventListener('click', () => {
                                searchResult.innerHTML = '';
                                activeEle.classList.remove('btn-success');
                                activeEle.classList.add('btn-light');
                                activeEle = null;
                            })
                        })
                })
                const image = document.querySelectorAll('.scanner') || document.querySelectorAll('.radio') || document.querySelectorAll('.analyse');
                    image.forEach(element => {
                        element.addEventListener('click', () => {
                            if (activeEle) {
                                activeEle.classList.remove('btn-success');
                                activeEle.classList.add('btn-light');
                            }
                            activeEle = element;
                            searchResult.innerHTML = '';
                            activeEle.classList.remove('btn-light');
                            activeEle.classList.add('btn-success');
                            const obj = response.find(e => e.medical_history_diagnosis == activeEle.innerHTML)
                            searchResult.innerHTML += `
                                <div class="card-body rounded border border-2"> 
                                    <p class="lead">${obj.medical_history_notes}</p>
                                    <a href="../../${obj.image_url}.png" target="_blank" class="btn btn-success">Open Image</a>
                                    <a href="../../${obj.image_url}.png" download class="btn btn-primary">Download Image</a>
                                    <button class="btn btn-danger text-white cls">Close</button>
                                </div>`;
                            const cls = searchResult.childNodes[1].childNodes[7];
                            cls.addEventListener('click', () => {
                                searchResult.innerHTML = '';
                                activeEle.classList.remove('btn-success');
                                activeEle.classList.add('btn-light');
                                activeEle = null;
                            })
                        })
                    })
            })
        });
        

    </script>
    <script>
        const treatmentType = document.querySelector('#treatmentType');
        const submitMedicalHistoryForm = document.querySelector('#submitMedicalHistoryForm');

        treatmentType.addEventListener('change', () => {
            treatmentType.classList.add('d-none');
            submitMedicalHistoryForm.classList.remove('d-none');
            let element = null;
            if (treatmentType.value == 'prescription') {
                element = createPrescription();
            }else if (treatmentType.value == 'scanner') {
                element = createScanner();
                medicalHistoryForm.setAttribute('enctype', 'multipart/form-data');
            }
            function createMedicine() {
                const div = document.createElement('div')
                div.classList.add('d-flex', 'gap-2', 'p-2')
                const medicationInput = document.createElement('input');
                medicationInput.classList.add('form-control');
                medicationInput.setAttribute('type', 'text');
                medicationInput.setAttribute('name', `medicine`);
                medicationInput.setAttribute('placeholder', 'Medication name');
                const dosageInput = document.createElement('input');
                dosageInput.classList.add('form-control', 'w-75');
                dosageInput.setAttribute('type', 'text');
                dosageInput.setAttribute('name', `dosage`);
                dosageInput.setAttribute('placeholder', 'Medication dosage');
                div.appendChild(medicationInput)
                div.appendChild(dosageInput);
                prescriptionContainer.insertBefore(div, addMedicineButton);
            }
            medicalHistoryForm.insertBefore(element, submitMedicalHistoryForm);
            const addMedicineButton = document.querySelector('#addNewMedicine');
            const prescriptionContainer = document.querySelector('#prescriptionContainer');
            addMedicineButton.addEventListener('click', () => {
                createMedicine();
            })
        })
    </script>
    <!-- Create Prescription/Scanner -->
    <script>
function createPrescription() {
            const div = document.createElement('div');
            div.classList.add('d-flex', 'flex-column', 'gap-2');
            div.setAttribute('id', 'prescriptionContainer');
            const diagnosisInput = document.createElement('input');
            diagnosisInput.classList.add('form-control');
            diagnosisInput.setAttribute('type', 'text');
            diagnosisInput.setAttribute('name', `diagnosis`);
            diagnosisInput.setAttribute('placeholder', 'Diagnosis');
            const notesInput = document.createElement('input');
            notesInput.classList.add('form-control');
            notesInput.setAttribute('type', 'text');
            notesInput.setAttribute('name', `notes`);
            notesInput.setAttribute('placeholder', 'notes');
            const dateInput = document.createElement('input');
            dateInput.classList.add('form-control');
            dateInput.setAttribute('type', 'datetime-local');
            dateInput.setAttribute('name', `date`);
            // const medicationInput = document.createElement('input');
            // medicationInput.classList.add('form-control');
            // medicationInput.setAttribute('type', 'text');
            // medicationInput.setAttribute('name', `medicine`);
            // medicationInput.setAttribute('placeholder', 'Medication name');
            // const dosageInput = document.createElement('input');
            // dosageInput.classList.add('form-control');
            // dosageInput.setAttribute('type', 'text');
            // dosageInput.setAttribute('name', `dosage`);
            // dosageInput.setAttribute('placeholder', 'Medication dosage');
            const buttonAddMedicine = document.createElement('button');
            buttonAddMedicine.classList.add('btn', 'purple-background', 'text-white', 'fw-bold', 'w-25');
            buttonAddMedicine.innerText = 'Add Medicine';
            buttonAddMedicine.setAttribute('id', 'addNewMedicine');
            buttonAddMedicine.setAttribute('type', 'button')
            div.appendChild(diagnosisInput);
            div.appendChild(notesInput);
            div.appendChild(dateInput);
            // div.appendChild(medicationInput);
            // div.appendChild(dosageInput);
            div.appendChild(buttonAddMedicine);
            return div;
        }
        function createScanner() {
            const div = document.createElement('div');
            div.classList.add('d-flex', 'flex-column', 'gap-2');
            const diagnosisInput = document.createElement('input');
            diagnosisInput.classList.add('form-control');
            diagnosisInput.setAttribute('type', 'text');
            diagnosisInput.setAttribute('name', `diagnosis`);
            diagnosisInput.setAttribute('placeholder', 'Diagnosis');
            const notesInput = document.createElement('input');
            notesInput.classList.add('form-control');
            notesInput.setAttribute('type', 'text');
            notesInput.setAttribute('name', `notes`);
            notesInput.setAttribute('placeholder', 'notes');
            const dateInput = document.createElement('input');
            dateInput.classList.add('form-control');
            dateInput.setAttribute('type', 'date');
            dateInput.setAttribute('name', `date`);
            const scannerInput = document.createElement('input');
            scannerInput.classList.add('form-control');
            scannerInput.setAttribute('type', 'file');
            scannerInput.setAttribute('name', `photos`);
            div.appendChild(diagnosisInput);
            div.appendChild(notesInput);
            div.appendChild(dateInput);
            div.appendChild(scannerInput);
            return div;
        }

    </script>


